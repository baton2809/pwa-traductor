<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Переводчик RU-ES</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RU-ES Переводчик">
    <meta name="theme-color" content="#c41e3a">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9IiNjNDFlM2EiLz4KPHA+CjxwYXRoIGQ9Ik05MCAyMGMtMjUgMC00NSAyMC00NSA0NXMyMCA0NSA0NSA0NSA0NS0yMCA0NS00NVM2OCAyMCA5MCAyMFoiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZDcwMCIgc3Ryb2tlLXdpZHRoPSI2Ii8+CjxwYXRoIGQ9Ik05MCAzNWMtMTcgMC0zMCAxMy0zMCAzMHMxMyAzMCAzMCAzMCAzMC0xMyAzMC0zMFMxMDcgMzUgOTAgMzVaIiBmaWxsPSIjZmZkNzAwIi8+CjxjaXJjbGUgY3g9IjkwIiBjeT0iNjUiIHI9IjEyIiBmaWxsPSIjYzQxZTNhIi8+CjxwYXRoIGQ9Ik03OCA3MmgxMmMwIDUtMyAxMC04IDEwcy04LTUtOC0xMFoiIGZpbGw9IiNmZmQ3MDAiLz4KPHBhdGggZD0iTTc1IDEyMGwyIDJjMTAgOCAyNSA4IDM1IDAgbC0yLTJjLTgtNi0yMS02LTI5IDBaIiBmaWxsPSIjZmZkNzAwIi8+CjxwYXRoIGQ9Ik04NSAxNDBoMTBjMiAwIDQgMiA0IDR2NmMwIDItMiA0LTQgNGgtMTBjLTIgMC00LTItNC00di02YzAtMiAyLTQgNC00WiIgZmlsbD0iI2M0MWUzYSIvPgo8L3A+Cjwvc3ZnPg==">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iI2M0MWUzYSIvPgo8Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSI4IiBzdHJva2U9IiNmZmQ3MDAiIHN0cm9rZS13aWR0aD0iMiIvPgo8Y2lyY2xlIGN4PSIxNiIgY3k9IjE2IiByPSI0IiBmaWxsPSIjZmZkNzAwIi8+Cjwvc3ZnPg==">
    <link rel="manifest" href="#" id="manifest-placeholder">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Цвета испанского флага */
            --red-spain: #c41e3a;
            --yellow-spain: #ffd700;
            --dark-red: #a01729;
            --light-yellow: #fff3a0;
            
            /* Дополнительные цвета */
            --background: #fef7cd;
            --surface: #ffffff;
            --text: #2d1b0e;
            --text-light: #8b4513;
            --border: #deb887;
            --shadow: 0 4px 6px -1px rgba(196, 30, 58, 0.15);
            --shadow-lg: 0 10px 15px -3px rgba(196, 30, 58, 0.2);
            --success: #228b22;
            --danger: var(--red-spain);
            --warning: #ff8c00;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            user-select: none;
            -webkit-user-select: none;
        }

        .app-container {
            min-height: 100vh;
            max-width: 500px;
            margin: 0 auto;
            background: var(--surface);
            box-shadow: var(--shadow-lg);
            position: relative;
        }

       .header {
           background: linear-gradient(135deg, var(--red-spain), var(--dark-red));
           color: white;
           padding: env(safe-area-inset-top, 20px) 20px 80px 20px;
           text-align: center;
           position: relative;
           overflow: visible;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 40%, var(--yellow-spain) 40%, var(--yellow-spain) 60%, transparent 60%);
            opacity: 0.1;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .language-switch {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            padding: 12px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .language-label {
            font-size: 1rem;
            font-weight: 700;
            min-width: 80px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .switch-btn {
            background: var(--yellow-spain);
            border: 3px solid white;
            color: var(--red-spain);
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 1.4rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .switch-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .microphone-container {
           position: fixed;
           top: 120px;
           left: 50%;
           transform: translateX(-50%);
           z-index: 100;
        }

        .main-microphone {
            width: 100px;
            height: 100px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 2.5rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            background: linear-gradient(135deg, var(--red-spain), var(--dark-red));
            color: white;
            box-shadow: 0 8px 25px rgba(196, 30, 58, 0.4);
        }

        .main-microphone::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: linear-gradient(45deg, var(--yellow-spain), var(--light-yellow));
            border-radius: 50%;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .main-microphone:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(196, 30, 58, 0.6);
        }

        .main-microphone:hover::before {
            opacity: 1;
        }

        .main-microphone.listening {
            background: linear-gradient(135deg, var(--yellow-spain), #f4c430);
            color: var(--red-spain);
            animation: microphonePulse 1.5s infinite;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
        }

        .main-microphone.listening::before {
            opacity: 1;
            animation: ringPulse 2s infinite;
        }

        @keyframes microphonePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes ringPulse {
            0% { 
                opacity: 1; 
                transform: scale(1); 
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.2); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        .microphone-icon {
            font-size: 2.5rem;
        }

        .main-content {
            padding: 70px 20px 120px 20px;
        }

        .status-bar {
            background: var(--surface);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--red-spain);
            border-right: 4px solid var(--yellow-spain);
        }

        .status-text {
            font-weight: 700;
            color: var(--red-spain);
            font-size: 1rem;
        }

        .listening-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .pulse {
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.3); }
            100% { opacity: 1; transform: scale(1); }
        }

        .conversation-area {
            min-height: 400px;
            margin-bottom: 20px;
        }

        .message {
            background: var(--surface);
            margin-bottom: 15px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: messageSlide 0.3s ease-out;
            border: 2px solid transparent;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            padding: 15px 20px;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .message-header.russian {
            background: linear-gradient(135deg, var(--red-spain), var(--dark-red));
            color: white;
        }

        .message-header.spanish {
            background: linear-gradient(135deg, var(--yellow-spain), #f4c430);
            color: var(--red-spain);
        }

        .message-content {
            padding: 20px;
            font-size: 1.2rem;
            line-height: 1.6;
            font-weight: 500;
        }

        .message.listening {
            border: 2px solid var(--yellow-spain);
            animation: listeningGlow 2s infinite;
        }

        @keyframes listeningGlow {
            0%, 100% { 
                border-color: var(--yellow-spain);
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4);
            }
            50% { 
                border-color: var(--red-spain);
                box-shadow: 0 0 0 10px rgba(255, 215, 0, 0);
            }
        }

        .bottom-controls {
           position: fixed;
           bottom: calc(env(safe-area-inset-bottom, 20px) + 20px);
           left: 50%;
           transform: translateX(-50%);
           display: flex;
           gap: 20px;
        }

        .clear-btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.8rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            background: linear-gradient(135deg, var(--text-light), #654321);
            color: white;
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
        }

        .clear-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.6);
        }

        .cache-info {
            text-align: center;
            color: var(--text-light);
            font-size: 0.85rem;
            padding: 12px;
            background: var(--background);
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 500;
        }

        .error {
            background: var(--danger);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
            animation: shake 0.5s ease-in-out;
            font-weight: 600;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .success {
            background: var(--success);
            color: white;
            padding: 12px 18px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
        }

        .partial-text {
            position: fixed;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: rgba(196, 30, 58, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 1rem;
            text-align: center;
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.3s ease-out;
            z-index: 50;
            border: 2px solid var(--yellow-spain);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .install-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--red-spain);
            color: white;
            padding: 15px 20px;
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .install-prompt.show {
            display: flex;
        }

        .install-btn {
            background: var(--yellow-spain);
            border: 1px solid white;
            color: var(--red-spain);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* iOS Safe Area */
        @supports (padding: max(0px)) {
            .app-container {
                padding-top: max(env(safe-area-inset-top), 0px);
                padding-bottom: max(env(safe-area-inset-bottom), 0px);
            }
        }

        /* Dark theme support */
        @media (prefers-color-scheme: dark) {
            :root {
                --background: #2d1810;
                --surface: #3d2418;
                --text: #f5deb3;
                --text-light: #deb887;
                --border: #8b4513;
            }
        }

        /* Welcome message styling */
        .welcome-message {
            text-align: center;
            color: var(--text-light);
            margin-top: 50px;
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--background), var(--surface));
            border-radius: 20px;
            border: 2px dashed var(--border);
        }

        .welcome-message h3 {
            font-size: 1.5rem;
            color: var(--red-spain);
            margin-bottom: 15px;
        }

        .welcome-message p {
            font-size: 1.1rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
   <div class="install-prompt" id="installPrompt">
       <div>
           <strong>Установить приложение?</strong><br>
           <small>Добавить на главный экран для быстрого доступа</small>
       </div>
       <div>
           <button class="install-btn" id="installBtn">Установить</button>
           <button class="install-btn" id="dismissBtn" style="margin-left: 10px;">Отмена</button>
       </div>
   </div>

   <div class="app-container">
       <header class="header">
           <h1>Traductor Español-Ruso</h1>
           <div class="language-switch">
               <span class="language-label" id="sourceLabel">РУССКИЙ</span>
               <button class="switch-btn" id="switchBtn" title="Переключить языки">⇄</button>
               <span class="language-label" id="targetLabel">ESPAÑOL</span>
           </div>
           
           <div class="microphone-container">
               <button class="main-microphone" id="listenBtn" title="Начать/остановить запись">
                   <span class="microphone-icon">🎤</span>
               </button>
           </div>
       </header>

       <main class="main-content">
           <div class="status-bar">
               <div class="status-text" id="statusText">Готов к работе</div>
               <div class="listening-indicator" id="listeningIndicator" style="display: none;">
                   <div class="pulse"></div>
                   <span id="listeningText">Слушаю...</span>
               </div>
           </div>

           <div class="conversation-area" id="conversationArea">
               <div class="welcome-message">
                   <h3>¡Bienvenido!</h3>
                   <p>Нажмите кнопку микрофона и начните говорить</p>
               </div>
           </div>

           <div class="cache-info" id="cacheInfo">
               Кэш: 0 переводов
           </div>
       </main>

       <div class="bottom-controls">
           <button class="clear-btn" id="clearBtn" title="Очистить историю">
               🗑️
           </button>
       </div>

       <div class="partial-text" id="partialText" style="display: none;"></div>
   </div>

   <script>
       class TranslatorPWA {
           constructor() {
               this.isListening = false;
               this.recognition = null;
               this.currentLang = 'ru'; // ru или es
               this.cache = this.loadCache();
               this.installPrompt = null;
               
               this.initElements();
               this.initSpeechRecognition();
               this.initPWA();
               this.updateUI();
               this.updateCacheInfo();
           }

           initElements() {
               this.statusText = document.getElementById('statusText');
               this.listeningIndicator = document.getElementById('listeningIndicator');
               this.listeningText = document.getElementById('listeningText');
               this.conversationArea = document.getElementById('conversationArea');
               this.sourceLabel = document.getElementById('sourceLabel');
               this.targetLabel = document.getElementById('targetLabel');
               this.listenBtn = document.getElementById('listenBtn');
               this.clearBtn = document.getElementById('clearBtn');
               this.switchBtn = document.getElementById('switchBtn');
               this.partialText = document.getElementById('partialText');
               this.cacheInfo = document.getElementById('cacheInfo');

               // Обработчики событий
               this.listenBtn.addEventListener('click', () => this.toggleListening());
               this.clearBtn.addEventListener('click', () => this.clearHistory());
               this.switchBtn.addEventListener('click', () => this.switchLanguages());

               // Предотвращение масштабирования на двойной тап
               document.addEventListener('touchstart', (e) => {
                   if (e.touches.length > 1) {
                       e.preventDefault();
                   }
               });

               let lastTouchEnd = 0;
               document.addEventListener('touchend', (e) => {
                   const now = (new Date()).getTime();
                   if (now - lastTouchEnd <= 300) {
                       e.preventDefault();
                   }
                   lastTouchEnd = now;
               }, false);
           }

           initSpeechRecognition() {
               if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                   this.showError('Распознавание речи не поддерживается в вашем браузере');
                   return;
               }

               const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
               this.recognition = new SpeechRecognition();

               this.recognition.continuous = true;
               this.recognition.interimResults = true;
               this.recognition.maxAlternatives = 1;

               this.recognition.onstart = () => {
                   this.isListening = true;
                   this.updateUI();
               };

               this.recognition.onend = () => {
                   this.isListening = false;
                   this.updateUI();
                   this.hidePartialText();
               };

               this.recognition.onerror = (event) => {
                   console.error('Speech recognition error:', event.error);
                   this.isListening = false;
                   this.updateUI();
                   
                   let errorMessage = 'Ошибка распознавания речи';
                   switch(event.error) {
                       case 'no-speech':
                           errorMessage = 'Речь не обнаружена. Попробуйте еще раз';
                           break;
                       case 'network':
                           errorMessage = 'Ошибка сети. Проверьте подключение к интернету';
                           break;
                       case 'not-allowed':
                           errorMessage = 'Доступ к микрофону заблокирован. Разрешите доступ';
                           break;
                   }
                   this.showError(errorMessage);
               };

               this.recognition.onresult = (event) => {
                   let interimTranscript = '';
                   let finalTranscript = '';

                   for (let i = event.resultIndex; i < event.results.length; i++) {
                       const transcript = event.results[i][0].transcript;
                       
                       if (event.results[i].isFinal) {
                           finalTranscript += transcript;
                       } else {
                           interimTranscript += transcript;
                       }
                   }

                   if (interimTranscript) {
                       this.showPartialText(interimTranscript);
                   }

                   if (finalTranscript.trim()) {
                       this.hidePartialText();
                       this.processText(finalTranscript.trim());
                   }
               };
           }

           initPWA() {
               // Регистрация Service Worker
               if ('serviceWorker' in navigator) {
                   this.registerServiceWorker();
               }

               // Обработка установки PWA
               window.addEventListener('beforeinstallprompt', (e) => {
                   e.preventDefault();
                   this.installPrompt = e;
                   this.showInstallPrompt();
               });

               // Установка обработчиков для промпта установки
               document.getElementById('installBtn').addEventListener('click', () => {
                   this.installApp();
               });

               document.getElementById('dismissBtn').addEventListener('click', () => {
                   this.hideInstallPrompt();
               });

               // Генерация манифеста
               this.generateManifest();
           }

           registerServiceWorker() {
               const swCode = `
               const CACHE_NAME = 'translator-pwa-v1';
               const urlsToCache = [
                   '/',
                   '/index.html'
               ];

               self.addEventListener('install', (event) => {
                   event.waitUntil(
                       caches.open(CACHE_NAME)
                           .then((cache) => cache.addAll(urlsToCache))
                   );
               });

               self.addEventListener('fetch', (event) => {
                   event.respondWith(
                       caches.match(event.request)
                           .then((response) => {
                               if (response) {
                                   return response;
                               }
                               return fetch(event.request);
                           }
                       )
                   );
               });
               `;

               const blob = new Blob([swCode], { type: 'application/javascript' });
               const swUrl = URL.createObjectURL(blob);

               navigator.serviceWorker.register(swUrl)
                   .then((registration) => {
                       console.log('SW registered:', registration);
                   })
                   .catch((error) => {
                       console.log('SW registration failed:', error);
                   });
           }

           generateManifest() {
               const manifest = {
                   name: "Переводчик Русский-Испанский",
                   short_name: "RU-ES Traductor",
                   description: "Голосовой переводчик с русского на испанский и обратно",
                   start_url: "/",
                   display: "standalone",
                   orientation: "portrait",
                   theme_color: "#c41e3a",
                   background_color: "#fef7cd",
                   icons: [
                       {
                           src: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iNDAiIGZpbGw9IiNjNDFlM2EiLz4KPHA+CjxwYXRoIGQ9Ik05NiA0MGMtMzAgMC01NSAyNS01NSA1NXMyNSA1NSA1NSA1NSA1NS0yNSA1NS01NVM2OCA0MCA5NiA0MFoiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZDcwMCIgc3Ryb2tlLXdpZHRoPSI4Ii8+CjxwYXRoIGQ9Ik05NiA2MGMtMjAgMC0zNSAxNS0zNSAzNXMxNSAzNSAzNSAzNSAzNS0xNSAzNS0zNVM4MSA2MCA5NiA2MFoiIGZpbGw9IiNmZmQ3MDAiLz4KPGNpcmNsZSBjeD0iOTYiIGN5PSI5NSIgcj0iMTUiIGZpbGw9IiNjNDFlM2EiLz4KPHBhdGggZD0iTTgwIDEwNWgyMGMwIDgtNSAxNS0xMCAxNXMtMTAtNy0xMC0xNVoiIGZpbGw9IiNmZmQ3MDAiLz4KPHBhdGggZD0iTTc1IDE0MGw0IDRjMTUgMTIgMzUgMTIgNTAgMCBsLTQtNGMtMTItOS0zMC05LTQyIDBaIiBmaWxsPSIjZmZkNzAwIi8+CjxwYXRoIGQ9Ik04NSAxNjBoMjBjMyAwIDUgMiA1IDV2OGMwIDMtMiA1LTUgNWgtMjBjLTMgMC01LTItNS01di04YzAtMyAyLTUgNS01WiIgZmlsbD0iI2M0MWUzYSIvPgo8L3A+Cjwvc3ZnPg==",
                           sizes: "192x192",
                           type: "image/svg+xml"
                       },
                       {
                           src: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iMTAwIiBmaWxsPSIjYzQxZTNhIi8+CjxwYXRoIGQ9Ik0yNTYgMTAwYy04MiAwLTE1MCA2OC0xNTAgMTUwczY4IDE1MCAxNTAgMTUwIDE1MC02OCAxNTAtMTUwUzI1NSAxMDAgMjU2IDEwMFoiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmZDcwMCIgc3Ryb2tlLXdpZHRoPSIyMCIvPgo8cGF0aCBkPSJNMjU2IDE1MGMtNTUgMC0xMDAgNDUtMTAwIDEwMHM0NSAxMDAgMTAwIDEwMCAxMDAtNDUgMTAwLTEwMFMzMTEgMTUwIDI1NiAxNTBaIiBmaWxsPSIjZmZkNzAwIi8+CjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1MCIgcj0iNDAiIGZpbGw9IiNjNDFlM2EiLz4KPHBhdGggZD0iTTIxNiAyODBoNjBjMCAyMC0xNSA0MC0zMCA0MHMtMzAtMjAtMzAtNDBaIiBmaWxsPSIjZmZkNzAwIi8+CjxwYXRoIGQ9Ik0yMDAgMzYwbDEwIDEwYzQwIDMwIDkwIDMwIDEzMCAwIGwtMTAtMTBjLTMwLTI1LTgwLTI1LTExMCAwWiIgZmlsbD0iI2ZmZDcwMCIvPgo8cGF0aCBkPSJNMjI2IDQyMGg2MGM4IDAgMTUgNyAxNSAxNXYyMGMwIDgtNyAxNS0xNSAxNWgtNjBjLTggMC0xNS03LTE1LTE1di0yMGMwLTggNy0xNSAxNS0xNVoiIGZpbGw9IiNjNDFlM2EiLz4KPC9zdmc+",
                           sizes: "512x512",
                           type: "image/svg+xml"
                       }
                   ]
               };

               const manifestBlob = new Blob([JSON.stringify(manifest)], {
                   type: 'application/json'
               });
               const manifestUrl = URL.createObjectURL(manifestBlob);
               document.getElementById('manifest-placeholder').href = manifestUrl;
           }

           showInstallPrompt() {
               document.getElementById('installPrompt').classList.add('show');
           }

           hideInstallPrompt() {
               document.getElementById('installPrompt').classList.remove('show');
           }

           async installApp() {
               if (this.installPrompt) {
                   this.installPrompt.prompt();
                   const result = await this.installPrompt.userChoice;
                   
                   if (result.outcome === 'accepted') {
                       console.log('PWA установлено');
                   }
                   
                   this.installPrompt = null;
                   this.hideInstallPrompt();
               }
           }

           toggleListening() {
               if (this.isListening) {
                   this.stopListening();
               } else {
                   this.startListening();
               }
           }

           startListening() {
               if (!this.recognition) {
                   this.showError('Распознавание речи недоступно');
                   return;
               }

               // Устанавливаем язык
               const lang = this.currentLang === 'ru' ? 'ru-RU' : 'es-ES';
               this.recognition.lang = lang;

               try {
                   this.recognition.start();
               } catch (error) {
                   console.error('Error starting recognition:', error);
                   this.showError('Не удалось начать распознавание');
               }
           }

           stopListening() {
               if (this.recognition && this.isListening) {
                   this.recognition.stop();
               }
           }

           async processText(text) {
               console.log('Processing text:', text);
               
               // Добавляем исходное сообщение
               this.addMessage(text, this.currentLang, 'original');
               
               // Переводим
               const targetLang = this.currentLang === 'ru' ? 'es' : 'ru';
               const translation = await this.translateText(text, this.currentLang, targetLang);
               
               if (translation) {
                   this.addMessage(translation, targetLang, 'translation');
               } else {
                   this.showError('Не удалось перевести текст');
               }
           }

           async translateText(text, fromLang, toLang) {
               // Проверяем кэш
               const cacheKey = this.getCacheKey(text, fromLang, toLang);
               const cached = this.cache[cacheKey];
               
               if (cached && this.isCacheValid(cached)) {
                   cached.accessCount = (cached.accessCount || 0) + 1;
                   cached.lastAccess = new Date().toISOString();
                   this.saveCache();
                   this.updateCacheInfo();
                   return cached.translation;
               }

               // API запрос
               try {
                   const url = 'https://api.mymemory.translated.net/get';
                   const params = new URLSearchParams({
                       q: text,
                       langpair: `${fromLang}|${toLang}`,
                       de: 'translator@example.com'
                   });

                   const response = await fetch(`${url}?${params}`, {
                       method: 'GET',
                       timeout: 8000
                   });

                   if (!response.ok) {
                       throw new Error(`HTTP ${response.status}`);
                   }

                   const data = await response.json();
                   
                   if (data.responseStatus === 200) {
                       const translation = data.responseData.translatedText;
                       
                       // Сохраняем в кэш
                       this.cache[cacheKey] = {
                           translation: translation,
                           timestamp: new Date().toISOString(),
                           accessCount: 1,
                           lastAccess: new Date().toISOString()
                       };
                       
                       this.cleanCache();
                       this.saveCache();
                       this.updateCacheInfo();
                       
                       return translation;
                   }
               } catch (error) {
                   console.error('Translation error:', error);
               }
               
               return null;
           }

           getCacheKey(text, fromLang, toLang) {
               const normalizedText = text.toLowerCase().trim().replace(/\s+/g, ' ');
               const cacheString = `${normalizedText}_${fromLang}_${toLang}`;
               
               // Простая хэш-функция
               let hash = 0;
               for (let i = 0; i < cacheString.length; i++) {
                   const char = cacheString.charCodeAt(i);
                   hash = ((hash << 5) - hash) + char;
                   hash = hash & hash; // 32-битное число
               }
               
               return hash.toString(36);
           }

           isCacheValid(cacheEntry) {
               const cacheDate = new Date(cacheEntry.timestamp);
               const now = new Date();
               const daysDiff = (now - cacheDate) / (1000 * 60 * 60 * 24);
               
               return daysDiff < 7; // 7 дней
           }

           cleanCache() {
               const maxSize = 500;
               const entries = Object.entries(this.cache);
               
               if (entries.length <= maxSize) return;
               
               // Сортируем по времени последнего доступа
               entries.sort((a, b) => {
                   const timeA = new Date(a[1].lastAccess || a[1].timestamp);
                   const timeB = new Date(b[1].lastAccess || b[1].timestamp);
                   return timeA - timeB;
               });
               
               // Удаляем старые записи
               const toRemove = entries.length - maxSize;
               for (let i = 0; i < toRemove; i++) {
                   delete this.cache[entries[i][0]];
               }
           }

           loadCache() {
               try {
                   const cached = localStorage.getItem('translator_cache');
                   return cached ? JSON.parse(cached) : {};
               } catch (error) {
                   console.error('Error loading cache:', error);
                   return {};
               }
           }

           saveCache() {
               try {
                   localStorage.setItem('translator_cache', JSON.stringify(this.cache));
               } catch (error) {
                   console.error('Error saving cache:', error);
               }
           }

           addMessage(text, lang, type) {
               const messageDiv = document.createElement('div');
               messageDiv.className = `message ${type === 'original' ? 'listening' : ''}`;
               
               const isRussian = lang === 'ru';
               const headerClass = isRussian ? 'russian' : 'spanish';
               const headerText = isRussian ? 'Русский' : 'Español';
               
               messageDiv.innerHTML = `
                   <div class="message-header ${headerClass}">
                       ${headerText}
                   </div>
                   <div class="message-content">${text}</div>
               `;
               
               // Удаляем приветственное сообщение
               const welcomeMsg = this.conversationArea.querySelector('.welcome-message');
               if (welcomeMsg) {
                   welcomeMsg.remove();
               }
               
               this.conversationArea.appendChild(messageDiv);
               
               // Прокручиваем к новому сообщению
               messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
               
               // Убираем эффект "listening" через секунду
               if (type === 'original') {
                   setTimeout(() => {
                       messageDiv.classList.remove('listening');
                   }, 1000);
               }
           }

           switchLanguages() {
               this.currentLang = this.currentLang === 'ru' ? 'es' : 'ru';
               this.updateUI();
               
               // Показываем уведомление
               this.showSuccess(`Переключено на ${this.currentLang === 'ru' ? 'русский' : 'испанский'}`);
           }

           clearHistory() {
               this.conversationArea.innerHTML = `
                   <div class="welcome-message">
                       <h3>¡Bienvenido!</h3>
                       <p>Нажмите кнопку микрофона и начните говорить</p>
                   </div>
               `;
               this.showSuccess('Historia borrada');
           }

           showPartialText(text) {
               this.partialText.textContent = text;
               this.partialText.style.display = 'block';
           }

           hidePartialText() {
               this.partialText.style.display = 'none';
           }

           showError(message) {
               const errorDiv = document.createElement('div');
               errorDiv.className = 'error';
               errorDiv.textContent = message;
               
               this.conversationArea.appendChild(errorDiv);
               errorDiv.scrollIntoView({ behavior: 'smooth' });
               
               setTimeout(() => {
                   errorDiv.remove();
               }, 5000);
           }

           showSuccess(message) {
               const successDiv = document.createElement('div');
               successDiv.className = 'success';
               successDiv.textContent = message;
               
               document.querySelector('.main-content').insertBefore(
                   successDiv, 
                   this.conversationArea
               );
               
               setTimeout(() => {
                   successDiv.remove();
               }, 3000);
           }

           updateUI() {
               // Обновляем кнопку прослушивания
               if (this.isListening) {
                   this.listenBtn.classList.add('listening');
                   this.statusText.textContent = this.currentLang === 'ru' ? 'Слушаю русский...' : 'Escuchando español...';
                   this.listeningText.textContent = this.currentLang === 'ru' ? 'Слушаю...' : 'Escuchando...';
                   this.listeningIndicator.style.display = 'flex';
               } else {
                   this.listenBtn.classList.remove('listening');
                   this.statusText.textContent = 'Listo para trabajar';
                   this.listeningIndicator.style.display = 'none';
               }
               
               // Обновляем метки языков
               if (this.currentLang === 'ru') {
                   this.sourceLabel.textContent = 'РУССКИЙ';
                   this.targetLabel.textContent = 'ESPAÑOL';
               } else {
                   this.sourceLabel.textContent = 'ESPAÑOL';
                   this.targetLabel.textContent = 'РУССКИЙ';
               }
           }

           updateCacheInfo() {
               const cacheSize = Object.keys(this.cache).length;
               const totalAccess = Object.values(this.cache)
                   .reduce((sum, entry) => sum + (entry.accessCount || 1), 0);
               
               this.cacheInfo.textContent = `Caché: ${cacheSize} traducciones, ${totalAccess} accesos`;
           }
       }

       // Запуск приложения
       document.addEventListener('DOMContentLoaded', () => {
           window.translator = new TranslatorPWA();
       });

       // Предотвращение случайного обновления страницы
       window.addEventListener('beforeunload', (e) => {
           if (window.translator && window.translator.isListening) {
               e.preventDefault();
               e.returnValue = '';
           }
       });
   </script>
</body>
</html>
