<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Переводчик RU-ES</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RU-ES Переводчик">
    <meta name="theme-color" content="#C60B1E">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9IiNDNjBCMUUiLz4KPHJlY3QgeD0iMjAiIHk9IjYwIiB3aWR0aD0iMTQwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRkZENzAwIi8+CjxjaXJjbGUgY3g9IjkwIiBjeT0iOTAiIHI9IjIwIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNODAgOTBoMjBtLTEwLTEwdjIwIiBzdHJva2U9IiNDNjBCMUUiIHN0cm9rZS13aWR0aD0iMyIvPgo8L3N2Zz4=">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iI0M2MEIxRSIvPgo8cmVjdCB4PSI0IiB5PSIxMiIgd2lkdGg9IjI0IiBoZWlnaHQ9IjgiIGZpbGw9IiNGRkQ3MDAiLz4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iNCIgZmlsbD0id2hpdGUiLz4KPC9zdmc+">
    <link rel="manifest" href="#" id="manifest-placeholder">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --spanish-red: #C60B1E;
            --spanish-yellow: #FFD700;
            --spanish-red-dark: #AA041E;
            --spanish-yellow-dark: #E6C200;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --medium-gray: #CCCCCC;
            --dark-gray: #333333;
            --text-dark: #1A1A1A;
            --text-medium: #666666;
            --shadow: 0 4px 12px rgba(198, 11, 30, 0.15);
            --shadow-lg: 0 8px 24px rgba(198, 11, 30, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
            background: var(--light-gray);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            user-select: none;
            -webkit-user-select: none;
        }

        .app-container {
            min-height: 100vh;
            max-width: 500px;
            margin: 0 auto;
            background: var(--white);
            position: relative;
            box-shadow: var(--shadow-lg);
        }

        .header {
            background: linear-gradient(135deg, var(--spanish-red), var(--spanish-red-dark));
            color: white;
            padding: env(safe-area-inset-top, 20px) 20px 20px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .header-icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .ios-badge {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 8px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .language-switch {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
            padding: 12px;
            background: rgba(255, 215, 0, 0.15);
            border-radius: 16px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .language-label {
            font-size: 0.9rem;
            font-weight: 600;
            min-width: 80px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .switch-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .switch-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .switch-icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .main-content {
            padding: 20px;
            padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 120px);
        }

        .translation-methods {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .method-btn {
            padding: 12px 8px;
            border: none;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .method-btn.active {
            background: var(--spanish-red);
            color: white;
            box-shadow: var(--shadow);
        }

        .method-btn:not(.active) {
            background: var(--medium-gray);
            color: var(--text-medium);
        }

        .method-btn:not(.active):hover {
            background: #DDDDDD;
        }

        .method-icon {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .status-bar {
            background: var(--white);
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--medium-gray);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-icon {
            width: 20px;
            height: 20px;
            fill: var(--spanish-red);
            flex-shrink: 0;
        }

        .status-text {
            font-weight: 500;
            color: var(--spanish-red);
            font-size: 0.9rem;
            flex: 1;
        }

        .conversation-area {
            min-height: 300px;
            margin-bottom: 20px;
        }

        .message {
            background: var(--white);
            margin-bottom: 12px;
            border-radius: 18px;
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: messageSlide 0.3s ease-out;
            border: 1px solid var(--medium-gray);
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            padding: 12px 16px;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .message-header.russian {
            background: linear-gradient(90deg, var(--spanish-red), var(--spanish-red-dark));
            color: white;
        }

        .message-header.spanish {
            background: linear-gradient(90deg, var(--spanish-yellow), var(--spanish-yellow-dark));
            color: var(--text-dark);
        }

        .message-header.system {
            background: var(--medium-gray);
            color: var(--text-dark);
        }

        .flag-icon {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .message-content {
            padding: 16px;
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .translation-confidence {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--light-gray);
            font-size: 0.75rem;
            color: var(--text-medium);
            border-top: 1px solid var(--medium-gray);
        }

        .confidence-bar {
            flex: 1;
            height: 4px;
            background: var(--medium-gray);
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--spanish-red), var(--spanish-yellow));
            transition: width 0.3s ease;
        }

        .controls {
            position: fixed;
            bottom: env(safe-area-inset-bottom, 20px);
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 16px 20px;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--medium-gray);
        }

        .control-btn {
            width: 56px;
            height: 56px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            position: relative;
        }

        .control-btn:hover {
            transform: translateY(-2px);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .listen-btn {
            background: linear-gradient(135deg, var(--spanish-red), var(--spanish-red-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(198, 11, 30, 0.3);
        }

        .listen-btn.listening {
            background: linear-gradient(135deg, var(--spanish-yellow), var(--spanish-yellow-dark));
            color: var(--text-dark);
            animation: listening 1.5s infinite;
        }

        @keyframes listening {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .ios-translate-btn {
            background: linear-gradient(135deg, var(--spanish-yellow), var(--spanish-yellow-dark));
            color: var(--text-dark);
        }

        .shortcuts-btn {
            background: linear-gradient(135deg, #666666, #333333);
            color: white;
        }

        .clear-btn {
            background: var(--medium-gray);
            color: var(--text-medium);
        }

        .control-icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .partial-text {
            position: fixed;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: rgba(198, 11, 30, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.9rem;
            text-align: center;
            backdrop-filter: blur(20px);
            z-index: 50;
            animation: fadeInUp 0.3s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ios-integration-panel {
            background: var(--white);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--medium-gray);
            box-shadow: var(--shadow);
        }

        .integration-title {
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .integration-option {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--light-gray);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .integration-option:hover {
            background: #EEEEEE;
            border-color: var(--spanish-red);
        }

        .option-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .option-icon svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .option-content {
            flex: 1;
        }

        .option-title {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .option-description {
            font-size: 0.75rem;
            color: var(--text-medium);
        }

        .welcome-message {
            text-align: center;
            color: var(--text-medium);
            margin-top: 40px;
            padding: 20px;
        }

        .welcome-message h3 {
            font-size: 1.2rem;
            margin-bottom: 12px;
            color: var(--text-dark);
            font-weight: 600;
        }

        .welcome-icon {
            width: 48px;
            height: 48px;
            fill: var(--spanish-red);
            margin-bottom: 16px;
        }

        .error {
            background: var(--spanish-red);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 10px 0;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .success {
            background: var(--spanish-yellow);
            color: var(--text-dark);
            padding: 12px 16px;
            border-radius: 12px;
            margin: 10px 0;
            text-align: center;
            font-weight: 500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .message-icon {
            width: 16px;
            height: 16px;
            fill: currentColor;
            flex-shrink: 0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --light-gray: #1C1C1E;
                --white: #2C2C2E;
                --medium-gray: #48484A;
                --text-dark: #FFFFFF;
                --text-medium: #8E8E93;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>
                <svg class="header-icon" viewBox="0 0 24 24">
                    <path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.01-4.65.51-6.81L9.5 4.5L6.18 7.82c-1.22 1.22-1.22 3.2 0 4.42L8.5 14.56l2.37-2.37zm2.51 2.54l-2.37-2.37L14.5 13.5l2.32 2.32c1.22 1.22 3.2 1.22 4.42 0l3.32-3.32-1.37-1.37c-2.16-1.5-4.87-1.23-6.81.51l-.03.03z"/>
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 5-5v3h6v4h-6v3z"/>
                </svg>
                Переводчик RU-ES
            </h1>
            <div class="ios-badge">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M18.71 19.5C17.88 20.74 17 21.95 15.66 21.97C14.32 21.99 13.89 21.18 12.37 21.18C10.84 21.18 10.37 21.95 9.1 21.99C7.79 22.03 6.8 20.68 5.96 19.47C4.25 17 2.94 12.45 4.7 9.39C5.57 7.87 7.13 6.91 8.82 6.88C10.1 6.86 11.32 7.75 12.11 7.75C12.89 7.75 14.37 6.68 15.92 6.84C16.57 6.87 18.39 7.1 19.56 8.82C19.47 8.88 17.39 10.1 17.41 12.63C17.44 15.65 20.06 16.66 20.09 16.67C20.06 16.74 19.67 18.11 18.71 19.5Z"/>
                </svg>
                iOS интеграция
            </div>
            <div class="language-switch">
                <span class="language-label" id="sourceLabel">Русский</span>
                <button class="switch-btn" id="switchBtn" title="Переключить языки">
                    <svg class="switch-icon" viewBox="0 0 24 24">
                        <path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/>
                    </svg>
                </button>
                <span class="language-label" id="targetLabel">Español</span>
            </div>
        </header>

        <main class="main-content">
            <div class="translation-methods">
                <button class="method-btn active" data-method="speech">
                    <svg class="method-icon" viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                    Голос
                </button>
                <button class="method-btn" data-method="ios">
                    <svg class="method-icon" viewBox="0 0 24 24">
                        <path d="M18.71 19.5C17.88 20.74 17 21.95 15.66 21.97C14.32 21.99 13.89 21.18 12.37 21.18C10.84 21.18 10.37 21.95 9.1 21.99C7.79 22.03 6.8 20.68 5.96 19.47C4.25 17 2.94 12.45 4.7 9.39C5.57 7.87 7.13 6.91 8.82 6.88C10.1 6.86 11.32 7.75 12.11 7.75C12.89 7.75 14.37 6.68 15.92 6.84C16.57 6.87 18.39 7.1 19.56 8.82C19.47 8.88 17.39 10.1 17.41 12.63C17.44 15.65 20.06 16.66 20.09 16.67C20.06 16.74 19.67 18.11 18.71 19.5Z"/>
                    </svg>
                    iOS
                </button>
                <button class="method-btn" data-method="shortcuts">
                    <svg class="method-icon" viewBox="0 0 24 24">
                        <path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18z"/>
                        <path d="M12 8v5l4.28 2.54.72-1.21-3.5-2.08V8z"/>
                    </svg>
                    Shortcuts
                </button>
                <button class="method-btn" data-method="share">
                    <svg class="method-icon" viewBox="0 0 24 24">
                        <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.50-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92S19.61 16.08 18 16.08z"/>
                    </svg>
                    Share
                </button>
            </div>

            <div class="status-bar">
                <svg class="status-icon" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                </svg>
                <div class="status-text" id="statusText">Готов к работе</div>
            </div>

            <div class="ios-integration-panel" id="iosPanel" style="display: none;">
                <div class="integration-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.71 19.5C17.88 20.74 17 21.95 15.66 21.97C14.32 21.99 13.89 21.18 12.37 21.18C10.84 21.18 10.37 21.95 9.1 21.99C7.79 22.03 6.8 20.68 5.96 19.47C4.25 17 2.94 12.45 4.7 9.39C5.57 7.87 7.13 6.91 8.82 6.88C10.1 6.86 11.32 7.75 12.11 7.75C12.89 7.75 14.37 6.68 15.92 6.84C16.57 6.87 18.39 7.1 19.56 8.82C19.47 8.88 17.39 10.1 17.41 12.63C17.44 15.65 20.06 16.66 20.09 16.67C20.06 16.74 19.67 18.11 18.71 19.5Z"/>
                    </svg>
                    Возможности iOS
                </div>
                
                <div class="integration-option" onclick="app.tryIOSTranslate()">
                    <div class="option-icon" style="background: var(--spanish-yellow); color: var(--text-dark);">
                        <svg viewBox="0 0 24 24">
                            <path d="M7.5 5.6L5 7l1.4-2.5L5 2l2.5 1.4L10 2 8.6 4.5 10 7 7.5 5.6zM19.5 15.4L22 14l-1.4 2.5L22 19l-2.5-1.4L17 19l1.4-2.5L17 14l2.5 1.4zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5L22 2zM13.34 12.78c-.72-.45-1.73-.45-2.46 0-.73.45-1.18 1.28-1.18 2.18s.45 1.73 1.18 2.18c.37.23.78.34 1.23.34.45 0 .86-.11 1.23-.34.73-.45 1.18-1.28 1.18-2.18s-.45-1.73-1.18-2.18z"/>
                        </svg>
                    </div>
                    <div class="option-content">
                        <div class="option-title">iOS Translation API</div>
                        <div class="option-description">Встроенный переводчик Safari (iOS 14+)</div>
                    </div>
                </div>

                <div class="integration-option" onclick="app.openShortcuts()">
                    <div class="option-icon" style="background: var(--spanish-red); color: white;">
                        <svg viewBox="0 0 24 24">
                            <path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18z"/>
                        </svg>
                    </div>
                    <div class="option-content">
                        <div class="option-title">Apple Shortcuts</div>
                        <div class="option-description">Интеграция с приложением "Команды"</div>
                    </div>
                </div>

                <div class="integration-option" onclick="app.openIOSTranslateApp()">
                    <div class="option-icon" style="background: #666666; color: white;">
                        <svg viewBox="0 0 24 24">
                            <path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.01-4.65.51-6.81L9.5 4.5L6.18 7.82c-1.22 1.22-1.22 3.2 0 4.42L8.5 14.56l2.37-2.37zm2.51 2.54l-2.37-2.37L14.5 13.5l2.32 2.32c1.22 1.22 3.2 1.22 4.42 0l3.32-3.32-1.37-1.37c-2.16-1.5-4.87-1.23-6.81.51l-.03.03z"/>
                        </svg>
                    </div>
                    <div class="option-content">
                        <div class="option-title">Приложение "Переводчик"</div>
                        <div class="option-description">Переход в нативное приложение iOS</div>
                    </div>
                </div>

                <div class="integration-option" onclick="app.shareToTranslate()">
                    <div class="option-icon" style="background: var(--medium-gray); color: white;">
                        <svg viewBox="0 0 24 24">
                            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.50-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92S19.61 16.08 18 16.08z"/>
                        </svg>
                    </div>
                    <div class="option-content">
                        <div class="option-title">Share Extension</div>
                        <div class="option-description">Отправка через меню "Поделиться"</div>
                    </div>
                </div>
            </div>

            <div class="conversation-area" id="conversationArea">
                <div class="welcome-message">
                    <svg class="welcome-icon" viewBox="0 0 24 24">
                        <path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.01-4.65.51-6.81L9.5 4.5L6.18 7.82c-1.22 1.22-1.22 3.2 0 4.42L8.5 14.56l2.37-2.37zm2.51 2.54l-2.37-2.37L14.5 13.5l2.32 2.32c1.22 1.22 3.2 1.22 4.42 0l3.32-3.32-1.37-1.37c-2.16-1.5-4.87-1.23-6.81.51l-.03.03z"/>
                    </svg>
                    <h3>Добро пожаловать!</h3>
                    <p>Выберите способ перевода выше или нажмите кнопку микрофона</p>
                </div>
            </div>
        </main>

        <div class="controls">
            <button class="control-btn listen-btn" id="listenBtn" title="Голосовой ввод">
                <svg class="control-icon" viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
            </button>
            <button class="control-btn ios-translate-btn" id="iosBtn" title="iOS Translate">
                <svg class="control-icon" viewBox="0 0 24 24">
                    <path d="M18.71 19.5C17.88 20.74 17 21.95 15.66 21.97C14.32 21.99 13.89 21.18 12.37 21.18C10.84 21.18 10.37 21.95 9.1 21.99C7.79 22.03 6.8 20.68 5.96 19.47C4.25 17 2.94 12.45 4.7 9.39C5.57 7.87 7.13 6.91 8.82 6.88C10.1 6.86 11.32 7.75 12.11 7.75C12.89 7.75 14.37 6.68 15.92 6.84C16.57 6.87 18.39 7.1 19.56 8.82C19.47 8.88 17.39 10.1 17.41 12.63C17.44 15.65 20.06 16.66 20.09 16.67C20.06 16.74 19.67 18.11 18.71 19.5Z"/>
                </svg>
            </button>
            <button class="control-btn shortcuts-btn" id="shortcutsBtn" title="Shortcuts">
                <svg class="control-icon" viewBox="0 0 24 24">
                    <path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18z"/>
                </svg>
            </button>
            <button class="control-btn clear-btn" id="clearBtn" title="Очистить">
                <svg class="control-icon" viewBox="0 0 24 24">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
            </button>
        </div>

        <div class="partial-text" id="partialText" style="display: none;"></div>
    </div>

    <script>
        class iOSTranslatorPWA {
            constructor() {
                this.isListening = false;
                this.recognition = null;
                this.currentLang = 'ru';
                this.currentMethod = 'speech';
                this.cache = this.loadCache();
                
                this.initElements();
                this.initSpeechRecognition();
                this.initPWA();
                this.detectIOSCapabilities();
                this.updateUI();
            }

            initElements() {
                this.statusText = document.getElementById('statusText');
                this.conversationArea = document.getElementById('conversationArea');
                this.sourceLabel = document.getElementById('sourceLabel');
                this.targetLabel = document.getElementById('targetLabel');
                this.listenBtn = document.getElementById('listenBtn');
                this.iosBtn = document.getElementById('iosBtn');
                this.shortcutsBtn = document.getElementById('shortcutsBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.switchBtn = document.getElementById('switchBtn');
                this.partialText = document.getElementById('partialText');
                this.iosPanel = document.getElementById('iosPanel');

                // Events
                this.listenBtn.addEventListener('click', () => this.toggleListening());
                this.iosBtn.addEventListener('click', () => this.tryIOSTranslate());
                this.shortcutsBtn.addEventListener('click', () => this.openShortcuts());
                this.clearBtn.addEventListener('click', () => this.clearHistory());
                this.switchBtn.addEventListener('click', () => this.switchLanguages());

                // Method buttons
                document.querySelectorAll('.method-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentMethod = btn.dataset.method;
                        this.updateMethodUI();
                    });
                });

                // Make app globally available
                window.app = this;
            }

            initSpeechRecognition() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.showError('Распознавание речи не поддерживается');
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();

                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.maxAlternatives = 1;

                this.recognition.onstart = () => {
                    this.isListening = true;
                    this.updateUI();
                };

                this.recognition.onend = () => {
                    this.isListening = false;
                    this.updateUI();
                    this.hidePartialText();
                };

                this.recognition.onerror = (event) => {
                    this.isListening = false;
                    this.updateUI();
                    this.handleSpeechError(event.error);
                };

                this.recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    if (interimTranscript) {
                        this.showPartialText(interimTranscript);
                    }

                    if (finalTranscript.trim()) {
                        this.hidePartialText();
                        this.processText(finalTranscript.trim());
                    }
                };
            }

            initPWA() {
                // Service Worker
                if ('serviceWorker' in navigator) {
                    this.registerServiceWorker();
                }

                // Manifest
                this.generateManifest();

                // iOS specific optimizations
                this.optimizeForIOS();
            }

            optimizeForIOS() {
                // Prevent zoom on input focus
                document.addEventListener('touchstart', (e) => {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                });

                // Prevent double-tap zoom
                let lastTouchEnd = 0;
                document.addEventListener('touchend', (e) => {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }

            detectIOSCapabilities() {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isIOSSafari = isIOS && /Safari/.test(navigator.userAgent);
                const iOSVersion = this.getIOSVersion();

                this.capabilities = {
                    isIOS: isIOS,
                    isIOSSafari: isIOSSafari,
                    iOSVersion: iOSVersion,
                    hasTranslationAPI: iOSVersion >= 14,
                    hasShortcuts: iOSVersion >= 12,
                    hasTranslateApp: iOSVersion >= 14
                };

                this.updateCapabilitiesUI();
            }

            getIOSVersion() {
                const match = navigator.userAgent.match(/OS (\d+)_/);
                return match ? parseInt(match[1]) : 0;
            }

            updateCapabilitiesUI() {
                const options = document.querySelectorAll('.integration-option');
                
                options.forEach((option, index) => {
                    const isAvailable = this.isCapabilityAvailable(index);
                    option.style.opacity = isAvailable ? '1' : '0.5';
                    
                    if (!isAvailable) {
                        const description = option.querySelector('.option-description');
                        description.textContent += ' (Недоступно)';
                    }
                });
            }

            isCapabilityAvailable(index) {
                switch(index) {
                    case 0: return this.capabilities.hasTranslationAPI;
                    case 1: return this.capabilities.hasShortcuts;
                    case 2: return this.capabilities.hasTranslateApp;
                    case 3: return this.capabilities.isIOS;
                    default: return false;
                }
            }

            // iOS Integration Methods
            async tryIOSTranslate() {
                if (!this.capabilities.hasTranslationAPI) {
                    this.showError('iOS Translation API недоступен на вашем устройстве');
                    return;
                }

                try {
                    if ('translation' in window) {
                        const result = await this.useTranslationAPI();
                        if (result) return;
                    }

                    if (this.recognition) {
                        this.statusText.textContent = 'Используем iOS речевые возможности...';
                        this.startListening();
                        return;
                    }

                    this.promptIOSTranslation();

                } catch (error) {
                    console.error('iOS Translation error:', error);
                    this.showError('Ошибка iOS Translation. Попробуйте другой метод');
                }
            }

            async useTranslationAPI() {
                try {
                    const translator = new window.Translator();
                    translator.sourceLanguage = this.currentLang;
                    translator.targetLanguage = this.currentLang === 'ru' ? 'es' : 'ru';
                    
                    const text = prompt('Введите текст для перевода:');
                    if (!text) return false;

                    const translation = await translator.translate(text);
                    this.addMessage(text, this.currentLang, 'original');
                    this.addMessage(translation, this.currentLang === 'ru' ? 'es' : 'ru', 'translation', 95);
                    
                    return true;
                } catch (error) {
                    console.log('Translation API не доступен:', error);
                    return false;
                }
            }

            promptIOSTranslation() {
                const text = prompt('Введите текст для перевода через iOS:');
                if (!text) return;

                this.addMessage(text, this.currentLang, 'original');
                
                const instruction = `Для перевода через iOS:
1. Скопируйте текст: "${text}"
2. Откройте приложение "Переводчик" 
3. Вставьте текст и переведите
4. Вернитесь в это приложение`;
                
                this.addMessage(instruction, 'system', 'instruction');
            }

            openShortcuts() {
                if (!this.capabilities.hasShortcuts) {
                    this.showError('Apple Shortcuts недоступны на вашем устройстве');
                    return;
                }

                const text = prompt('Введите текст для перевода через Shortcuts:');
                if (!text) return;

                const shortcutName = 'Translate Text';
                const encodedText = encodeURIComponent(text);
                const shortcutsURL = `shortcuts://run-shortcut?name=${shortcutName}&input=${encodedText}`;

                try {
                    window.location.href = shortcutsURL;
                    
                    this.addMessage(text, this.currentLang, 'original');
                    this.addMessage('Переход в Shortcuts для перевода...', 'system', 'instruction');
                    
                } catch (error) {
                    this.showError('Не удалось открыть Shortcuts');
                }
            }

            openIOSTranslateApp() {
                if (!this.capabilities.hasTranslateApp) {
                    this.showError('Приложение "Переводчик" недоступно на вашем устройстве');
                    return;
                }

                const text = prompt('Введите текст для перевода в приложении "Переводчик":');
                if (!text) return;

                this.copyToClipboard(text);
                
                const translateURL = 'translate://';
                
                try {
                    window.location.href = translateURL;
                    this.showSuccess('Текст скопирован! Откройте приложение "Переводчик" и вставьте');
                } catch (error) {
                    this.showError('Не удалось открыть приложение "Переводчик"');
                }
            }

            shareToTranslate() {
                const text = prompt('Введите текст для отправки через Share Extension:');
                if (!text) return;

                if (navigator.share) {
                    navigator.share({
                        title: 'Перевести текст',
                        text: text
                    }).then(() => {
                        this.showSuccess('Текст отправлен для перевода');
                    }).catch((error) => {
                        console.error('Error sharing:', error);
                        this.fallbackShare(text);
                    });
                } else {
                    this.fallbackShare(text);
                }
            }

            fallbackShare(text) {
                this.copyToClipboard(text);
                this.showSuccess('Текст скопирован в буфер обмена');
            }

            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                } catch (error) {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                }
            }

            toggleListening() {
                if (this.isListening) {
                    this.stopListening();
                } else {
                    this.startListening();
                }
            }

            startListening() {
                if (!this.recognition) {
                    this.showError('Распознавание речи недоступно');
                    return;
                }

                const lang = this.currentLang === 'ru' ? 'ru-RU' : 'es-ES';
                this.recognition.lang = lang;

                try {
                    this.recognition.start();
                } catch (error) {
                    this.showError('Не удалось начать распознавание');
                }
            }

            stopListening() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                }
            }

            async processText(text) {
                this.addMessage(text, this.currentLang, 'original');
                
                const targetLang = this.currentLang === 'ru' ? 'es' : 'ru';
                const translation = await this.translateText(text, this.currentLang, targetLang);
                
                if (translation) {
                    this.addMessage(translation.text, targetLang, 'translation', translation.confidence);
                } else {
                    this.showError('Не удалось перевести текст');
                }
            }

            async translateText(text, fromLang, toLang) {
                try {
                    const url = 'https://api.mymemory.translated.net/get';
                    const params = new URLSearchParams({
                        q: text,
                        langpair: `${fromLang}|${toLang}`,
                        de: 'ios-translator@example.com'
                    });

                    const response = await fetch(`${url}?${params}`, {
                        method: 'GET',
                        timeout: 8000
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const data = await response.json();
                    
                    if (data.responseStatus === 200) {
                        return {
                            text: data.responseData.translatedText,
                            confidence: 85
                        };
                    }
                } catch (error) {
                    console.error('Translation error:', error);
                }
                
                return null;
            }

            addMessage(text, lang, type, confidence = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                
                let headerClass = '';
                let headerText = '';
                let flagIcon = '';
                
                if (lang === 'ru') {
                    headerClass = 'russian';
                    headerText = 'Русский';
                    flagIcon = '<svg class="flag-icon" viewBox="0 0 24 24"><rect width="24" height="8" fill="white"/><rect y="8" width="24" height="8" fill="#0052B4"/><rect y="16" width="24" height="8" fill="#D80027"/></svg>';
                } else if (lang === 'es') {
                    headerClass = 'spanish';
                    headerText = 'Español';
                    flagIcon = '<svg class="flag-icon" viewBox="0 0 24 24"><rect width="24" height="6" fill="#C60B1E"/><rect y="6" width="24" height="12" fill="#FFD700"/><rect y="18" width="24" height="6" fill="#C60B1E"/></svg>';
                } else if (lang === 'system') {
                    headerClass = 'system';
                    headerText = 'Система';
                    flagIcon = '<svg class="flag-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>';
                }
                
                let confidenceHtml = '';
                if (confidence !== null) {
                    confidenceHtml = `
                        <div class="translation-confidence">
                            <span>Точность: ${confidence}%</span>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidence}%"></div>
                            </div>
                        </div>
                    `;
                }

                messageDiv.innerHTML = `
                    <div class="message-header ${headerClass}">
                        ${flagIcon}
                        ${headerText}
                    </div>
                    <div class="message-content">${text}</div>
                    ${confidenceHtml}
                `;
                
                const welcomeMsg = this.conversationArea.querySelector('.welcome-message');
                if (welcomeMsg) {
                    welcomeMsg.remove();
                }
                
                this.conversationArea.appendChild(messageDiv);
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            switchLanguages() {
                this.currentLang = this.currentLang === 'ru' ? 'es' : 'ru';
                this.updateUI();
                this.showSuccess(`Переключено на ${this.currentLang === 'ru' ? 'русский' : 'испанский'}`);
            }

            clearHistory() {
                this.conversationArea.innerHTML = `
                    <div class="welcome-message">
                        <svg class="welcome-icon" viewBox="0 0 24 24">
                            <path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.01-4.65.51-6.81L9.5 4.5L6.18 7.82c-1.22 1.22-1.22 3.2 0 4.42L8.5 14.56l2.37-2.37zm2.51 2.54l-2.37-2.37L14.5 13.5l2.32 2.32c1.22 1.22 3.2 1.22 4.42 0l3.32-3.32-1.37-1.37c-2.16-1.5-4.87-1.23-6.81.51l-.03.03z"/>
                        </svg>
                        <h3>Добро пожаловать!</h3>
                        <p>Выберите способ перевода выше или нажмите кнопку микрофона</p>
                    </div>
                `;
                this.showSuccess('История очищена');
            }

            updateUI() {
                // Update listening button
                if (this.isListening) {
                    this.listenBtn.classList.add('listening');
                    this.statusText.textContent = 'Слушаю...';
                } else {
                    this.listenBtn.classList.remove('listening');
                    this.statusText.textContent = 'Готов к работе';
                }
                
                // Update language labels
                if (this.currentLang === 'ru') {
                    this.sourceLabel.textContent = 'Русский';
                    this.targetLabel.textContent = 'Español';
                } else {
                    this.sourceLabel.textContent = 'Español';
                    this.targetLabel.textContent = 'Русский';
                }
            }

            updateMethodUI() {
                switch(this.currentMethod) {
                    case 'ios':
                        this.iosPanel.style.display = 'block';
                        this.statusText.textContent = 'Режим: iOS Integration';
                        break;
                    case 'shortcuts':
                        this.iosPanel.style.display = 'none';
                        this.statusText.textContent = 'Режим: Apple Shortcuts';
                        break;
                    case 'share':
                        this.iosPanel.style.display = 'none';
                        this.statusText.textContent = 'Режим: Share Extension';
                        break;
                    default:
                        this.iosPanel.style.display = 'none';
                        this.statusText.textContent = 'Готов к работе';
                }
            }

            showPartialText(text) {
                this.partialText.textContent = text;
                this.partialText.style.display = 'block';
            }

            hidePartialText() {
                this.partialText.style.display = 'none';
            }

            handleSpeechError(error) {
                let errorMessage = 'Ошибка распознавания речи';
                switch(error) {
                    case 'no-speech':
                        errorMessage = 'Речь не обнаружена';
                        break;
                    case 'network':
                        errorMessage = 'Ошибка сети';
                        break;
                    case 'not-allowed':
                        errorMessage = 'Доступ к микрофону заблокирован';
                        break;
                    case 'audio-capture':
                        errorMessage = 'Ошибка захвата аудио';
                        break;
                    case 'service-not-allowed':
                        errorMessage = 'Сервис не разрешен';
                        break;
                }
                this.showError(errorMessage);
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `
                    <svg class="message-icon" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                    ${message}
                `;
                
                const main = document.querySelector('.main-content');
                main.insertBefore(errorDiv, main.firstChild);
                
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 5000);
            }

            showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.innerHTML = `
                    <svg class="message-icon" viewBox="0 0 24 24">
                        <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                    </svg>
                    ${message}
                `;
                
                const main = document.querySelector('.main-content');
                main.insertBefore(successDiv, main.firstChild);
                
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.remove();
                    }
                }, 3000);
            }

            // Cache Management
            loadCache() {
                try {
                    const cached = localStorage.getItem('ios-translator-cache');
                    return cached ? JSON.parse(cached) : {};
                } catch (error) {
                    console.error('Cache load error:', error);
                    return {};
                }
            }

            saveCache() {
                try {
                    localStorage.setItem('ios-translator-cache', JSON.stringify(this.cache));
                } catch (error) {
                    console.error('Cache save error:', error);
                }
            }

            getCachedTranslation(text, fromLang, toLang) {
                const key = `${text}-${fromLang}-${toLang}`;
                return this.cache[key] || null;
            }

            setCachedTranslation(text, fromLang, toLang, translation) {
                const key = `${text}-${fromLang}-${toLang}`;
                this.cache[key] = {
                    translation,
                    timestamp: Date.now()
                };
                this.saveCache();
            }

            // Service Worker Registration
            async registerServiceWorker() {
                try {
                    const swScript = `
                        const CACHE_NAME = 'ios-translator-v1.0.0';
                        const urlsToCache = [
                            '/',
                            '/index.html',
                            'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9IiNDNjBCMUUiLz4KPHJlY3QgeD0iMjAiIHk9IjYwIiB3aWR0aD0iMTQwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRkZENzAwIi8+CjxjaXJjbGUgY3g9IjkwIiBjeT0iOTAiIHI9IjIwIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNODAgOTBoMjBtLTEwLTEwdjIwIiBzdHJva2U9IiNDNjBCMUUiIHN0cm9rZS13aWR0aD0iMyIvPgo8L3N2Zz4='
                        ];

                        self.addEventListener('install', (event) => {
                            event.waitUntil(
                                caches.open(CACHE_NAME)
                                    .then((cache) => cache.addAll(urlsToCache))
                            );
                        });

                        self.addEventListener('fetch', (event) => {
                            event.respondWith(
                                caches.match(event.request)
                                    .then((response) => {
                                        if (response) {
                                            return response;
                                        }
                                        return fetch(event.request);
                                    })
                            );
                        });

                        self.addEventListener('activate', (event) => {
                            event.waitUntil(
                                caches.keys().then((cacheNames) => {
                                    return Promise.all(
                                        cacheNames.map((cacheName) => {
                                            if (cacheName !== CACHE_NAME) {
                                                return caches.delete(cacheName);
                                            }
                                        })
                                    );
                                })
                            );
                        });
                    `;

                    const blob = new Blob([swScript], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);

                    const registration = await navigator.serviceWorker.register(swUrl);
                    console.log('ServiceWorker registered successfully');

                    return registration;
                } catch (error) {
                    console.error('ServiceWorker registration failed:', error);
                }
            }

            // Generate PWA Manifest
            generateManifest() {
                const manifestData = {
                    "name": "Переводчик RU-ES",
                    "short_name": "RU-ES",
                    "description": "Переводчик русский-испанский с iOS интеграцией",
                    "start_url": "/",
                    "display": "standalone",
                    "background_color": "#FFFFFF",
                    "theme_color": "#C60B1E",
                    "orientation": "portrait",
                    "categories": ["productivity", "utilities"],
                    "lang": "ru",
                    "icons": [
                        {
                            "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iNDAiIGZpbGw9IiNDNjBCMUUiLz4KPHJlY3QgeD0iMjQiIHk9IjcyIiB3aWR0aD0iMTQ0IiBoZWlnaHQ9IjQ4IiBmaWxsPSIjRkZENzAwIi8+CjxjaXJjbGUgY3g9Ijk2IiBjeT0iOTYiIHI9IjI0IiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNODQgOTZoMjRtLTEyLTEydjI0IiBzdHJva2U9IiNDNjBCMUUiIHN0cm9rZS13aWR0aD0iNCIvPgo8L3N2Zz4=",
                            "sizes": "192x192",
                            "type": "image/svg+xml",
                            "purpose": "any maskable"
                        },
                        {
                            "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iMTAwIiBmaWxsPSIjQzYwQjFFIi8+CjxyZWN0IHg9IjY0IiB5PSIxOTIiIHdpZHRoPSIzODQiIGhlaWdodD0iMTI4IiBmaWxsPSIjRkZENzAwIi8+CjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iNjQiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0yMjQgMjU2aDY0bS0zMi0zMnY2NCIgc3Ryb2tlPSIjQzYwQjFFIiBzdHJva2Utd2lkdGg9IjEwIi8+Cjwvc3ZnPg==",
                            "sizes": "512x512",
                            "type": "image/svg+xml",
                            "purpose": "any maskable"
                        }
                    ],
                    "shortcuts": [
                        {
                            "name": "Голосовой перевод",
                            "short_name": "Голос",
                            "description": "Быстрый голосовой перевод",
                            "url": "/?mode=voice",
                            "icons": [
                                {
                                    "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTYiIGhlaWdodD0iOTYiIHZpZXdCb3g9IjAgMCA5NiA5NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9Ijk2IiBoZWlnaHQ9Ijk2IiByeD0iMjQiIGZpbGw9IiNDNjBCMUUiLz4KPHBhdGggZD0iTTQ4IDU2YzYuNjMgMCAxMi01LjM3IDEyLTEyVjIwYzAtNi42My01LjM3LTEyLTEyLTEyczEyIDUuMzcgMTIgMTJ2MjRjMCA2LjYzIDUuMzcgMTIgMTIgMTJ6bTIwLTI4YzAgMTEuMDUtOC45NSAyMC0yMCAyMHMtMjAtOC45NS0yMC0yMEgyMGMwIDE0LjEzIDEwLjQ3IDI1LjcyIDI0IDI3LjY5VjY4aDh2LTEyLjMxQzY1LjUzIDUzLjcyIDc2IDQyLjEzIDc2IDI4aDh6IiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4=",
                                    "sizes": "96x96"
                                }
                            ]
                        },
                        {
                            "name": "iOS Переводчик",
                            "short_name": "iOS",
                            "description": "Использовать iOS функции",
                            "url": "/?mode=ios",
                            "icons": [
                                {
                                    "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTYiIGhlaWdodD0iOTYiIHZpZXdCb3g9IjAgMCA5NiA5NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9Ijk2IiBoZWlnaHQ9Ijk2IiByeD0iMjQiIGZpbGw9IiNGRkQ3MDAiLz4KPHBhdGggZD0iTTc0Ljg0IDc4Yy0zLjMyIDUuMTctNi4yMiAxMC4wNi0xMC42NCAxMC4xMi00LjQyLjA2LTUuODMtMi42Mi0xMC45Mi0yLjYyLTUuMDggMC02LjY5IDIuNTctMTAuOSAyLjY4LTQuMzMuMTEtNy41OC01LjE4LTEwLjY1LTEwLjM2LTYuMjgtMTAuNi05LjgzLTI2Ljg1LTQuMTctMzguNTYgMi43OC01Ljc4IDcuNzQtOS40NSAxMy4xOC05LjUzIDQuMTEtLjA2IDgtLjAzIDEwLjU5IDMuMjggNS44NSAyLjA0IDEwLjU5LTEuNzQgMTQuOTMtMS40NCAyLjU3LjEyIDkuOCAxLjAzIDEyLjQ0IDcuNzQuMDctLjAzIDguMi00LjczIDguMjctMTMuODguMDYtMTIuMDUtMTAuMDctMTYuMS05Ljk3LTMyLjI1LjA5LTE1LjczIDEzLjE5LTIwLjE2IDEzLjE5LTIwLjE2LTcuMjMtMTAuNTEtMTguNDgtOS42Ny0yMC4zMy05LjM3LTQuMy4yNS04LjM2IDIuNTQtMTAuNTcgMi41NC0yLjIgMC01LjYxLTIuNS05LjIxLTIuNDJaIiBmaWxsPSIjMzMzMzMzIi8+Cjwvc3ZnPg==",
                                    "sizes": "96x96"
                                }
                            ]
                        }
                    ]
                };

                const manifestJson = JSON.stringify(manifestData);
                const manifestBlob = new Blob([manifestJson], { type: 'application/json' });
                const manifestURL = URL.createObjectURL(manifestBlob);
                
                document.getElementById('manifest-placeholder').href = manifestURL;
            }

            // Enhanced translation with improved caching and error handling
            async translateText(text, fromLang, toLang) {
                // Check cache first
                const cached = this.getCachedTranslation(text, fromLang, toLang);
                if (cached && Date.now() - cached.timestamp < 86400000) { // 24 hours
                    return cached.translation;
                }

                const translationMethods = [
                    () => this.translateWithMyMemory(text, fromLang, toLang),
                    () => this.translateWithLibreTranslate(text, fromLang, toLang),
                    () => this.translateWithYandex(text, fromLang, toLang)
                ];

                for (const method of translationMethods) {
                    try {
                        const result = await method();
                        if (result) {
                            this.setCachedTranslation(text, fromLang, toLang, result);
                            return result;
                        }
                    } catch (error) {
                        console.log('Translation method failed, trying next...', error);
                        continue;
                    }
                }

                return null;
            }

            async translateWithMyMemory(text, fromLang, toLang) {
                const url = 'https://api.mymemory.translated.net/get';
                const params = new URLSearchParams({
                    q: text,
                    langpair: `${fromLang}|${toLang}`,
                    de: 'ios-translator@example.com'
                });

                const response = await fetch(`${url}?${params}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                
                if (data.responseStatus === 200) {
                    return {
                        text: data.responseData.translatedText,
                        confidence: Math.max(85, Math.min(95, data.matches?.[0]?.quality || 85))
                    };
                }

                throw new Error('MyMemory API error');
            }

            async translateWithLibreTranslate(text, fromLang, toLang) {
                // Fallback translation using a different service
                // This is a placeholder - you would need to implement actual LibreTranslate API
                throw new Error('LibreTranslate not implemented');
            }

            async translateWithYandex(text, fromLang, toLang) {
                // Another fallback option - placeholder
                throw new Error('Yandex not implemented');
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new iOSTranslatorPWA();
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (window.app && document.hidden && window.app.isListening) {
                window.app.stopListening();
            }
        });

    </script>
</body>
</html>
