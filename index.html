<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Переводчик RU-ES</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Traductor de Artyom">
    <meta name="theme-color" content="#c41e3a">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4SU DIbPNsNAA">
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAADZ0lEQVR4nO2XTUhUQRzHZxdBKwhCwYOgHYpCDx2sg3aJwm56kbIiJTtIEF46eOhQJx86dOgSdeiQBBGBHkpKCTpEUEGQBy9BB0kvRQdBhKCDIGSB/zf8e8y8N/v25s02F/rDf2bem3m/95+ZN+9N7+zs/M+fCwQCOaVSaSDwCbgHXAbOAGeBOcByYAmwHFgFrAbWAguBQaEOyHXZlwCvgJfAS+B7kJgcVnZRFgAzgLnAPGBm2wJJI5BSsgXYB9zCDfAdOzb8Drgez+8D9gBTugIgDTCNDgL7dRFbgA+6jk3AFmAL8BR4I1EEXraxGXgFfAI+Ax+Bd8Bb4A2jlC1Q3PiE+xRPWJsG7AJ2ApuBqX8NIAm4ByzWKG8EHgOvJZBAdqLEEDiPgeea63bgoa6lZdZKdmHOcZ9kcWlW1w5Z9SshcKB59JZGZ71GZQvw2ZI9tJ7FBfAQeGYJCawXWsW25sXqW1aaJwQOtJF6dZNEZZF6xb4V/KU2w2QQOFBHygCOq5b3qQY4VNfaJLjfhkMvBkDgEyuAOcAcYK5y/wPANYnQfmfZT8CdJvJQBLOsR1YG7r0bDn1YsgsBkCGcJ1p7nJgO3DdbXRRBFHYCoT2a/5KY/VzCaNgGZVGTYFCJSRS1hCVQOJQoKquFPrNIgiWOjOBzKyKBAlOzEiNQKGWJyEJ3qlKkdQKFT9uc0zJDxVJ8Xid+K4rSVTt+pwKAMOHCbHjOdTKaGw1vdnBmXgc0DlPBZyHgDEOYoGvUOHYmNqF3vF4JBgdNB6QDHABLglGiQo8AB4Bai2pRdUAOIGfR6FPEb8Y5tKI/pA1TA1QBjD4L3adaJ7WqPiWTOjAikFckx2fT/gC8BN4A76XGa5dJ/W9E4E1e7UHzpAGJbkxj4xj3mfWzQCYKrSjJQF2UgfkA3ajacoX6iGX2sW3FHlV1kYKZ3Ncs1IHaJfCJXZp3ELhBBfJ1vfKn8D+iO6BHBUuSYqKjajP6YNlrBR6qAOW95sKUPY2ZT9wTquwT1v+RJHzFEoCVyoFaPgGngtcYi9I5C9K0BlgJrF6WPT8CVgELgKHALqeNmMgfF1d6SaKJYgKGLNNE4zdlJ+H8QWOaYggkUNiVlCj3N0nF4eJVT1DIAAA=">
    <link rel="manifest" href="#" id="manifest-placeholder">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Цвета испанского флага */
            --red-spain: #c41e3a;
            --yellow-spain: #ffd700;
            --dark-red: #a01729;
            --light-yellow: #fff3a0;
            
            /* Дополнительные цвета */
            --background: #fef7cd;
            --surface: #ffffff;
            --text: #2d1b0e;
            --text-light: #8b4513;
            --border: #deb887;
            --shadow: 0 4px 6px -1px rgba(196, 30, 58, 0.15);
            --shadow-lg: 0 10px 15px -3px rgba(196, 30, 58, 0.2);
            --success: #228b22;
            --danger: var(--red-spain);
            --warning: #ff8c00;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            user-select: none;
            -webkit-user-select: none;
        }

        .app-container {
            min-height: 100vh;
            max-width: 500px;
            margin: 0 auto;
            background: var(--surface);
            box-shadow: var(--shadow-lg);
            position: relative;
        }

       .header {
           background: linear-gradient(135deg, var(--red-spain), var(--dark-red));
           color: white;
           padding: env(safe-area-inset-top, 20px) 20px 40px 20px;
           text-align: center;
           position: relative;
           overflow: visible;
        }
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 40%, var(--yellow-spain) 40%, var(--yellow-spain) 60%, transparent 60%);
            opacity: 0.1;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .language-switch {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            padding: 12px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .language-label {
            font-size: 1rem;
            font-weight: 700;
            min-width: 80px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .switch-btn {
            background: var(--yellow-spain);
            border: 3px solid white;
            color: var(--red-spain);
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 1.4rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .switch-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .main-content {
            padding: 20px 20px 120px 20px;
        }

        .status-bar {
            background: var(--surface);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--red-spain);
            border-right: 4px solid var(--yellow-spain);
            transition: all 0.3s ease;
        }

        .status-bar.hidden {
            opacity: 0;
            transform: translateY(-20px);
            pointer-events: none;
        }

        .status-text {
            font-weight: 700;
            color: var(--red-spain);
            font-size: 1rem;
        }

        .listening-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .pulse {
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.3); }
            100% { opacity: 1; transform: scale(1); }
        }

        .conversation-area {
            min-height: 400px;
            margin-bottom: 20px;
        }

        .message {
            background: var(--surface);
            margin-bottom: 15px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: messageSlide 0.3s ease-out;
            border: 2px solid transparent;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            padding: 15px 20px;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .message-header.russian {
            background: linear-gradient(135deg, var(--red-spain), var(--dark-red));
            color: white;
        }

        .message-header.spanish {
            background: linear-gradient(135deg, var(--yellow-spain), #f4c430);
            color: var(--red-spain);
        }

        .message-content {
            padding: 20px;
            font-size: 1.2rem;
            line-height: 1.6;
            font-weight: 500;
        }

        .message.listening {
            border: 2px solid var(--yellow-spain);
            animation: listeningGlow 2s infinite;
        }

        @keyframes listeningGlow {
            0%, 100% { 
                border-color: var(--yellow-spain);
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4);
            }
            50% { 
                border-color: var(--red-spain);
                box-shadow: 0 0 0 10px rgba(255, 215, 0, 0);
            }
        }

        .bottom-controls {
           position: fixed;
           bottom: calc(env(safe-area-inset-bottom, 20px) + 20px);
           left: 50%;
           transform: translateX(-50%);
           display: flex;
           gap: 15px;
           align-items: center;
        }

        .main-microphone, .clear-btn, .mute-btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.8rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 6px 20px rgba(196, 30, 58, 0.4);
        }

        .main-microphone {
            background: linear-gradient(135deg, var(--red-spain), var(--dark-red));
            color: white;
        }

        .main-microphone::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: linear-gradient(45deg, var(--yellow-spain), var(--light-yellow));
            border-radius: 50%;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .main-microphone:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(196, 30, 58, 0.6);
        }

        .main-microphone:hover::before {
            opacity: 1;
        }

        .main-microphone.listening {
            background: linear-gradient(135deg, var(--yellow-spain), #f4c430);
            color: var(--red-spain);
            animation: microphonePulse 1.5s infinite;
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }

        .main-microphone.listening::before {
            opacity: 1;
            animation: ringPulse 2s infinite;
        }

        @keyframes microphonePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes ringPulse {
            0% { 
                opacity: 1; 
                transform: scale(1); 
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.2); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1); 
            }
        }

        .clear-btn {
            background: linear-gradient(135deg, var(--text-light), #654321);
            color: white;
            box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4);
        }

        .clear-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.6);
        }

        .mute-btn {
            background: linear-gradient(135deg, var(--yellow-spain), #f4c430);
            color: var(--red-spain);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        .mute-btn.muted {
            background: linear-gradient(135deg, #888, #666);
            color: white;
            box-shadow: 0 6px 20px rgba(136, 136, 136, 0.4);
        }

        .mute-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
        }

        .mute-btn.muted:hover {
            box-shadow: 0 8px 25px rgba(136, 136, 136, 0.6);
        }

        .cache-info {
            text-align: center;
            color: var(--text-light);
            font-size: 0.85rem;
            padding: 12px;
            background: var(--background);
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 500;
        }

        .error {
            background: var(--danger);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
            animation: shake 0.5s ease-in-out;
            font-weight: 600;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .success {
            background: var(--success);
            color: white;
            padding: 12px 18px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
        }

        .partial-text {
            position: fixed;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: rgba(196, 30, 58, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 1rem;
            text-align: center;
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.3s ease-out;
            z-index: 50;
            border: 2px solid var(--yellow-spain);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .install-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--red-spain);
            color: white;
            padding: 15px 20px;
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .install-prompt.show {
            display: flex;
        }

        .install-btn {
            background: var(--yellow-spain);
            border: 1px solid white;
            color: var(--red-spain);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* iOS Safe Area */
        @supports (padding: max(0px)) {
            .app-container {
                padding-top: max(env(safe-area-inset-top), 0px);
                padding-bottom: max(env(safe-area-inset-bottom), 0px);
            }
        }

        /* Dark theme support */
        @media (prefers-color-scheme: dark) {
            :root {
                --background: #2d1810;
                --surface: #3d2418;
                --text: #f5deb3;
                --text-light: #deb887;
                --border: #8b4513;
            }
        }
    </style>
</head>
<body>
   <div class="install-prompt" id="installPrompt">
       <div>
           <strong>Установить приложение?</strong><br>
           <small>Добавить на главный экран для быстрого доступа</small>
       </div>
       <div>
           <button class="install-btn" id="installBtn">Установить</button>
           <button class="install-btn" id="dismissBtn" style="margin-left: 10px;">Отмена</button>
       </div>
   </div>

   <div class="app-container">
       <header class="header">
           <h1>Traductor Español-Ruso</h1>
           <div class="language-switch">
               <span class="language-label" id="sourceLabel">РУССКИЙ</span>
               <button class="switch-btn" id="switchBtn" title="Переключить языки">⇄</button>
               <span class="language-label" id="targetLabel">ESPAÑOL</span>
           </div>
       </header>

       <main class="main-content">
           <div class="status-bar" id="statusBar">
               <div class="status-text" id="statusText">Listo para trabajar</div>
               <div class="listening-indicator" id="listeningIndicator" style="display: none;">
                   <div class="pulse"></div>
                   <span id="listeningText">Слушаю...</span>
               </div>
           </div>

           <div class="conversation-area" id="conversationArea">
           </div>

           <div class="cache-info" id="cacheInfo">
               Кэш: 0 переводов
           </div>
       </main>

       <div class="bottom-controls">
           <button class="main-microphone" id="listenBtn" title="Начать/остановить запись">
               🎤
           </button>
           <button class="mute-btn" id="muteBtn" title="Включить/выключить озвучивание">
               🔊
           </button>
           <button class="clear-btn" id="clearBtn" title="Очистить историю">
               🗑️
           </button>
       </div>

       <div class="partial-text" id="partialText" style="display: none;"></div>
   </div>

   <script>
       class TranslatorPWA {
           constructor() {
               this.isListening = false;
               this.recognition = null;
               this.currentLang = 'ru'; // ru или es
               this.cache = this.loadCache();
               this.installPrompt = null;
               this.hasStartedListening = false;
               this.isMuted = false; // Звук включен по умолчанию
               this.speechSynthesis = window.speechSynthesis;
               
               this.initElements();
               this.initSpeechRecognition();
               this.initPWA();
               this.updateUI();
               this.updateCacheInfo();
               this.updateMuteButton(); // Инициализируем кнопку mute
           }

           initElements() {
               this.statusText = document.getElementById('statusText');
               this.statusBar = document.getElementById('statusBar');
               this.listeningIndicator = document.getElementById('listeningIndicator');
               this.listeningText = document.getElementById('listeningText');
               this.conversationArea = document.getElementById('conversationArea');
               this.sourceLabel = document.getElementById('sourceLabel');
               this.targetLabel = document.getElementById('targetLabel');
               this.listenBtn = document.getElementById('listenBtn');
               this.clearBtn = document.getElementById('clearBtn');
               this.switchBtn = document.getElementById('switchBtn');
               this.muteBtn = document.getElementById('muteBtn');
               this.partialText = document.getElementById('partialText');
               this.cacheInfo = document.getElementById('cacheInfo');

               // Обработчики событий
               this.listenBtn.addEventListener('click', () => this.toggleListening());
               this.clearBtn.addEventListener('click', () => this.clearHistory());
               this.switchBtn.addEventListener('click', () => this.switchLanguages());
               this.muteBtn.addEventListener('click', () => this.toggleMute());

               // Предотвращение масштабирования на двойной тап
               document.addEventListener('touchstart', (e) => {
                   if (e.touches.length > 1) {
                       e.preventDefault();
                   }
               });

               let lastTouchEnd = 0;
               document.addEventListener('touchend', (e) => {
                   const now = (new Date()).getTime();
                   if (now - lastTouchEnd <= 300) {
                       e.preventDefault();
                   }
                   lastTouchEnd = now;
               }, false);
           }

           initSpeechRecognition() {
               if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                   this.showError('Распознавание речи не поддерживается в вашем браузере');
                   return;
               }

               const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
               this.recognition = new SpeechRecognition();

               this.recognition.continuous = true;
               this.recognition.interimResults = true;
               this.recognition.maxAlternatives = 1;

               this.recognition.onstart = () => {
                   this.isListening = true;
                   if (!this.hasStartedListening) {
                       this.hasStartedListening = true;
                       this.hideStatusBar();
                   }
                   this.updateUI();
               };

               this.recognition.onend = () => {
                   this.isListening = false;
                   this.updateUI();
                   this.hidePartialText();
               };

               this.recognition.onerror = (event) => {
                   console.error('Speech recognition error:', event.error);
                   this.isListening = false;
                   this.updateUI();
                   
                   let errorMessage = 'Ошибка распознавания речи';
                   switch(event.error) {
                       case 'no-speech':
                           errorMessage = 'Речь не обнаружена. Попробуйте еще раз';
                           break;
                       case 'network':
                           errorMessage = 'Ошибка сети. Проверьте подключение к интернету';
                           break;
                       case 'not-allowed':
                           errorMessage = 'Доступ к микрофону заблокирован. Разрешите доступ';
                           break;
                   }
                   this.showError(errorMessage);
               };

               this.recognition.onresult = (event) => {
                   let interimTranscript = '';
                   let finalTranscript = '';

                   for (let i = event.resultIndex; i < event.results.length; i++) {
                       const transcript = event.results[i][0].transcript;
                       
                       if (event.results[i].isFinal) {
                           finalTranscript += transcript;
                       } else {
                           interimTranscript += transcript;
                       }
                   }

                   if (interimTranscript) {
                       this.showPartialText(interimTranscript);
                   }

                   if (finalTranscript.trim()) {
                       this.hidePartialText();
                       this.processText(finalTranscript.trim());
                   }
               };
           }

           initPWA() {
               // Регистрация Service Worker
               if ('serviceWorker' in navigator) {
                   this.registerServiceWorker();
               }

               // Обработка установки PWA
               window.addEventListener('beforeinstallprompt', (e) => {
                   e.preventDefault();
                   this.installPrompt = e;
                   this.showInstallPrompt();
               });

               // Установка обработчиков для промпта установки
               document.getElementById('installBtn').addEventListener('click', () => {
                   this.installApp();
               });

               document.getElementById('dismissBtn').addEventListener('click', () => {
                   this.hideInstallPrompt();
               });

               // Генерация манифеста
               this.generateManifest();
           }

           registerServiceWorker() {
               const swCode = `
               const CACHE_NAME = 'translator-pwa-v1';
               const urlsToCache = [
                   '/',
                   '/index.html'
               ];

               self.addEventListener('install', (event) => {
                   event.waitUntil(
                       caches.open(CACHE_NAME)
                           .then((cache) => cache.addAll(urlsToCache))
                   );
               });

               self.addEventListener('fetch', (event) => {
                   event.respondWith(
                       caches.match(event.request)
                           .then((response) => {
                               if (response) {
                                   return response;
                               }
                               return fetch(event.request);
                           }
                       )
                   );
               });
               `;

               const blob = new Blob([swCode], { type: 'application/javascript' });
               const swUrl = URL.createObjectURL(blob);

               navigator.serviceWorker.register(swUrl)
                   .then((registration) => {
                       console.log('SW registered:', registration);
                   })
                   .catch((error) => {
                       console.log('SW registration failed:', error);
                   });
           }

           generateManifest() {
               const manifest = {
                   name: "Traductor de Artyom",
                   short_name: "Traductor de Artyom",
                   description: "Голосовой переводчик с русского на испанский и обратно",
                   start_url: "/",
                   display: "standalone",
                   orientation: "portrait",
                   theme_color: "#c41e3a",
                   background_color: "#fef7cd",
                   icons: [
                       {
                           src: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iNDAiIGZpbGw9InVybCgjZ3JhZDEpIi8+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9ImdyYWQxIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I2M0MWUzYTtzdG9wLW9wYWNpdHk6MSIgLz4KPHN0b3Agb2Zmc2V0PSI1MCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmZmQ3MDA7c3RvcC1vcGFjaXR5OjEiIC8+CjxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6I2M0MWUzYTtzdG9wLW9wYWNpdHk6MSIgLz4KPC9saW5lYXJHcmFkaWVudD4KPC9kZWZzPgo8IS0tIE1pY3JvcGhvbmUgaWNvbiAtLT4KPGNpcmNsZSBjeD0iOTYiIGN5PSI5NiIgcj0iNTAiIGZpbGw9IndoaXRlIiBvcGFjaXR5PSIwLjkiLz4KPHBhdGggZD0iTTk2IDcwYy0xMCAwLTE4IDgtMTggMTh2MjBjMCAxMCA4IDE4IDE4IDE4czE4LTggMTgtMThWODhjMC0xMC04LTE4LTE4LTE4WiIgZmlsbD0iI2M0MWUzYSIvPgo8cGF0aCBkPSJNNzYgMTE2YzAgMTggMTAgMzAgMjAgMzBzMzAtMTIgMzAtMzAiIHN0cm9rZT0iI2M0MWUzYSIgc3Ryb2tlLXdpZHRoPSI2IiBmaWxsPSJub25lIi8+CjxsaW5lIHgxPSI5NiIgeTE9IjE0NiIgeDI9Ijk2IiB5Mj0iMTU4IiBzdHJva2U9IiNjNDFlM2EiIHN0cm9rZS13aWR0aD0iNiIvPgo8bGluZSB4MT0iNzYiIHkxPSIxNTgiIHgyPSIxMTYiIHkyPSIxNTgiIHN0cm9rZT0iI2M0MWUzYSIgc3Ryb2tlLXdpZHRoPSI2Ii8+CjwhLS0gVGV4dCAtLT4KPHRleHQgeD0iOTYiIHk9IjMyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCI+VFJBRFVDVE9SPC90ZXh0Pgo8dGV4dCB4PSI5NiIgeT0iMTg2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmb250LXdlaWdodD0iYm9sZCI+REUgQVJUWU9NPC90ZXh0Pgo8L3N2Zz4=",
                           sizes: "192x192",
                           type: "image/svg+xml"
                       },
                       {
                           src: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iMTAwIiBmaWxsPSJ1cmwoI2dyYWQxKSIvPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkMSIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNjNDFlM2E7c3RvcC1vcGFjaXR5OjEiIC8+CjxzdG9wIG9mZnNldD0iNTAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZmZkNzAwO3N0b3Atb3BhY2l0eToxIiAvPgo8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNjNDFlM2E7c3RvcC1vcGFjaXR5OjEiIC8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPCEtLSBNaWNyb3Bob25lIGljb24gLS0+CjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTIwIiBmaWxsPSJ3aGl0ZSIgb3BhY2l0eT0iMC45Ii8+CjxwYXRoIGQ9Ik0yNTYgMTgwYy0yNSAwLTQ1IDIwLTQ1IDQ1djQ1YzAgMjUgMjAgNDUgNDUgNDVzNDUtMjAgNDUtNDVWMjI1YzAtMjUtMjAtNDUtNDUtNDVaIiBmaWxsPSIjYzQxZTNhIi8+CjxwYXRoIGQ9Ik0xOTYgMjk1YzAgNDAgMjcgNzUgNjAgNzVzNzUtMzUgNzUtNzUiIHN0cm9rZT0iI2M0MWUzYSIgc3Ryb2tlLXdpZHRoPSIxNSIgZmlsbD0ibm9uZSIvPgo8bGluZSB4MT0iMjU2IiB5MT0iMzcwIiB4Mj0iMjU2IiB5Mj0iMzk1IiBzdHJva2U9IiNjNDFlM2EiIHN0cm9rZS13aWR0aD0iMTUiLz4KPGxpbmUgeDE9IjIwNiIgeTE9IjM5NSIgeDI9IjMwNiIgeTI9IjM5NSIgc3Ryb2tlPSIjYzQxZTNhIiBzdHJva2Utd2lkdGg9IjE1Ii8+CjwhLS0gVGV4dCAtLT4KPHRleHQgeD0iMjU2IiB5PSI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIzNiIgZm9udC13ZWlnaHQ9ImJvbGQiPlRSQURVQ1RPUjwvdGV4dD4KPHRleHQgeD0iMjU2IiB5PSI0NjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMzAiIGZvbnQtd2VpZ2h0PSJib2xkIj5ERSBBUlRZT008L3RleHQ+Cjwvc3ZnPg==",
                           sizes: "512x512",
                           type: "image/svg+xml"
                       }
                   ]
               };

               const manifestBlob = new Blob([JSON.stringify(manifest)], {
                   type: 'application/json'
               });
               const manifestUrl = URL.createObjectURL(manifestBlob);
               document.getElementById('manifest-placeholder').href = manifestUrl;
           }

           showInstallPrompt() {
               document.getElementById('installPrompt').classList.add('show');
           }

           hideInstallPrompt() {
               document.getElementById('installPrompt').classList.remove('show');
           }

           async installApp() {
               if (this.installPrompt) {
                   this.installPrompt.prompt();
                   const result = await this.installPrompt.userChoice;
                   
                   if (result.outcome === 'accepted') {
                       console.log('PWA установлено');
                   }
                   
                   this.installPrompt = null;
                   this.hideInstallPrompt();
               }
           }

           hideStatusBar() {
               this.statusBar.classList.add('hidden');
           }

           toggleListening() {
               if (this.isListening) {
                   this.stopListening();
               } else {
                   this.startListening();
               }
           }

           startListening() {
               if (!this.recognition) {
                   this.showError('Распознавание речи недоступно');
                   return;
               }

               // Устанавливаем язык
               const lang = this.currentLang === 'ru' ? 'ru-RU' : 'es-ES';
               this.recognition.lang = lang;

               try {
                   this.recognition.start();
               } catch (error) {
                   console.error('Error starting recognition:', error);
                   this.showError('Не удалось начать распознавание');
               }
           }

           stopListening() {
               if (this.recognition && this.isListening) {
                   this.recognition.stop();
               }
           }

           async processText(text) {
               console.log('Processing text:', text);
               
               // Добавляем исходное сообщение
               this.addMessage(text, this.currentLang, 'original');
               
               // Переводим
               const targetLang = this.currentLang === 'ru' ? 'es' : 'ru';
               const translation = await this.translateText(text, this.currentLang, targetLang);
               
               if (translation) {
                   this.addMessage(translation, targetLang, 'translation');
                   // Озвучиваем перевод, если не выключен звук
                   if (!this.isMuted) {
                       this.speakText(translation, targetLang);
                   }
               } else {
                   this.showError('Не удалось перевести текст');
               }
           }

           async translateText(text, fromLang, toLang) {
               // Проверяем кэш
               const cacheKey = this.getCacheKey(text, fromLang, toLang);
               const cached = this.cache[cacheKey];
               
               if (cached && this.isCacheValid(cached)) {
                   cached.accessCount = (cached.accessCount || 0) + 1;
                   cached.lastAccess = new Date().toISOString();
                   this.saveCache();
                   this.updateCacheInfo();
                   return cached.translation;
               }

               // API запрос
               try {
                   const url = 'https://api.mymemory.translated.net/get';
                   const params = new URLSearchParams({
                       q: text,
                       langpair: `${fromLang}|${toLang}`,
                       de: 'translator@example.com'
                   });

                   const response = await fetch(`${url}?${params}`, {
                       method: 'GET',
                       timeout: 8000
                   });

                   if (!response.ok) {
                       throw new Error(`HTTP ${response.status}`);
                   }

                   const data = await response.json();
                   
                   if (data.responseStatus === 200) {
                       const translation = data.responseData.translatedText;
                       
                       // Сохраняем в кэш
                       this.cache[cacheKey] = {
                           translation: translation,
                           timestamp: new Date().toISOString(),
                           accessCount: 1,
                           lastAccess: new Date().toISOString()
                       };
                       
                       this.cleanCache();
                       this.saveCache();
                       this.updateCacheInfo();
                       
                       return translation;
                   }
               } catch (error) {
                   console.error('Translation error:', error);
               }
               
               return null;
           }

           getCacheKey(text, fromLang, toLang) {
               const normalizedText = text.toLowerCase().trim().replace(/\s+/g, ' ');
               const cacheString = `${normalizedText}_${fromLang}_${toLang}`;
               
               // Простая хэш-функция
               let hash = 0;
               for (let i = 0; i < cacheString.length; i++) {
                   const char = cacheString.charCodeAt(i);
                   hash = ((hash << 5) - hash) + char;
                   hash = hash & hash; // 32-битное число
               }
               
               return hash.toString(36);
           }

           isCacheValid(cacheEntry) {
               const cacheDate = new Date(cacheEntry.timestamp);
               const now = new Date();
               const daysDiff = (now - cacheDate) / (1000 * 60 * 60 * 24);
               
               return daysDiff < 7; // 7 дней
           }

           cleanCache() {
               const maxSize = 500;
               const entries = Object.entries(this.cache);
               
               if (entries.length <= maxSize) return;
               
               // Сортируем по времени последнего доступа
               entries.sort((a, b) => {
                   const timeA = new Date(a[1].lastAccess || a[1].timestamp);
                   const timeB = new Date(b[1].lastAccess || b[1].timestamp);
                   return timeA - timeB;
               });
               
               // Удаляем старые записи
               const toRemove = entries.length - maxSize;
               for (let i = 0; i < toRemove; i++) {
                   delete this.cache[entries[i][0]];
               }
           }

           loadCache() {
               try {
                   const cached = localStorage.getItem('translator_cache');
                   return cached ? JSON.parse(cached) : {};
               } catch (error) {
                   console.error('Error loading cache:', error);
                   return {};
               }
           }

           saveCache() {
               try {
                   localStorage.setItem('translator_cache', JSON.stringify(this.cache));
               } catch (error) {
                   console.error('Error saving cache:', error);
               }
           }

           addMessage(text, lang, type) {
               const messageDiv = document.createElement('div');
               messageDiv.className = `message ${type === 'original' ? 'listening' : ''}`;
               
               const isRussian = lang === 'ru';
               const headerClass = isRussian ? 'russian' : 'spanish';
               const headerText = isRussian ? 'Русский' : 'Español';
               
               messageDiv.innerHTML = `
                   <div class="message-header ${headerClass}">
                       ${headerText}
                   </div>
                   <div class="message-content">${text}</div>
               `;
               
               this.conversationArea.appendChild(messageDiv);
               
               // Прокручиваем к новому сообщению
               messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
               
               // Убираем эффект "listening" через секунду
               if (type === 'original') {
                   setTimeout(() => {
                       messageDiv.classList.remove('listening');
                   }, 1000);
               }
           }

           switchLanguages() {
               this.currentLang = this.currentLang === 'ru' ? 'es' : 'ru';
               this.updateUI();
               
               // Показываем уведомление
               this.showSuccess(`Переключено на ${this.currentLang === 'ru' ? 'русский' : 'испанский'}`);
           }

           toggleMute() {
               this.isMuted = !this.isMuted;
               this.updateMuteButton();
               
               // Останавливаем текущее воспроизведение если включили мут
               if (this.isMuted && this.speechSynthesis.speaking) {
                   this.speechSynthesis.cancel();
               }
               
               this.showSuccess(this.isMuted ? 'Звук выключен' : 'Звук включен');
           }

           speakText(text, lang) {
               // Останавливаем предыдущее воспроизведение
               if (this.speechSynthesis.speaking) {
                   this.speechSynthesis.cancel();
               }

               const utterance = new SpeechSynthesisUtterance(text);
               
               // Устанавливаем язык
               utterance.lang = lang === 'ru' ? 'ru-RU' : 'es-ES';
               
               // Настройки голоса
               utterance.rate = 0.9;
               utterance.pitch = 1;
               utterance.volume = 1;

               // Запускаем воспроизведение
               this.speechSynthesis.speak(utterance);
           }

           updateMuteButton() {
               if (this.isMuted) {
                   this.muteBtn.classList.add('muted');
                   this.muteBtn.textContent = '🔇';
                   this.muteBtn.title = 'Включить озвучивание';
               } else {
                   this.muteBtn.classList.remove('muted');
                   this.muteBtn.textContent = '🔊';
                   this.muteBtn.title = 'Выключить озвучивание';
               }
           }

           clearHistory() {
               this.conversationArea.innerHTML = '';
               this.showSuccess('Historia borrada');
           }

           showPartialText(text) {
               this.partialText.textContent = text;
               this.partialText.style.display = 'block';
           }

           hidePartialText() {
               this.partialText.style.display = 'none';
           }

           showError(message) {
               const errorDiv = document.createElement('div');
               errorDiv.className = 'error';
               errorDiv.textContent = message;
               
               this.conversationArea.appendChild(errorDiv);
               errorDiv.scrollIntoView({ behavior: 'smooth' });
               
               setTimeout(() => {
                   errorDiv.remove();
               }, 5000);
           }

           showSuccess(message) {
               const successDiv = document.createElement('div');
               successDiv.className = 'success';
               successDiv.textContent = message;
               
               document.querySelector('.main-content').insertBefore(
                   successDiv, 
                   this.conversationArea
               );
               
               setTimeout(() => {
                   successDiv.remove();
               }, 3000);
           }

           updateUI() {
               // Обновляем кнопку прослушивания
               if (this.isListening) {
                   this.listenBtn.classList.add('listening');
                   this.statusText.textContent = this.currentLang === 'ru' ? 'Слушаю русский...' : 'Escuchando español...';
                   this.listeningText.textContent = this.currentLang === 'ru' ? 'Слушаю...' : 'Escuchando...';
                   this.listeningIndicator.style.display = 'flex';
               } else {
                   this.listenBtn.classList.remove('listening');
                   this.statusText.textContent = 'Listo para trabajar';
                   this.listeningIndicator.style.display = 'none';
               }
               
               // Обновляем метки языков
               if (this.currentLang === 'ru') {
                   this.sourceLabel.textContent = 'РУССКИЙ';
                   this.targetLabel.textContent = 'ESPAÑOL';
               } else {
                   this.sourceLabel.textContent = 'ESPAÑOL';
                   this.targetLabel.textContent = 'РУССКИЙ';
               }
           }

           updateCacheInfo() {
               const cacheSize = Object.keys(this.cache).length;
               const totalAccess = Object.values(this.cache)
                   .reduce((sum, entry) => sum + (entry.accessCount || 1), 0);
               
               this.cacheInfo.textContent = `Caché: ${cacheSize} traducciones, ${totalAccess} accesos`;
           }
       }

       // Запуск приложения
       document.addEventListener('DOMContentLoaded', () => {
           window.translator = new TranslatorPWA();
       });

       // Предотвращение случайного обновления страницы
       window.addEventListener('beforeunload', (e) => {
           if (window.translator && window.translator.isListening) {
               e.preventDefault();
               e.returnValue = '';
           }
       });
   </script>
</body>
</html>
